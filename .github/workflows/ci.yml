name: Continuous Integration

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  discussions: write
  issues: read

jobs:
  test-typescript:
    name: TypeScript Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .node-version
          cache: npm
      - run: npm ci
      - run: npm run format:check
      - run: npm run lint
      - run: npm run ci-test

  test-action-default:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Test Local Action
        uses: ./
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-action-default-last24:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - id: last
        run: |
          echo "day=$(date -d 'yesterday' +'%Y-%m-%dT%H:%M:%S')" >> "$GITHUB_OUTPUT"
      - name: Test Local Action
        uses: ./
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          query: |
            owner:sethrylan repo:issue-digest-test updated:>=${{ steps.last.outputs.day }}
          title: 'Issue Radar since ${{ steps.last.outputs.day }}'

  test-action-weekly-discussion:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - id: last
        run: |
          echo "monday=$(date -d 'last Monday' '+%Y-%m-%d')" >> "$GITHUB_OUTPUT"
          echo "day=$(date -d 'yesterday' +'%Y-%m-%dT%H:%M:%S')" >> "$GITHUB_OUTPUT"
      - name: Test Local Action
        uses: ./
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          intro: |
            ðŸ’¾ This discussion was created by the [CI workflow](https://github.com/sethrylan/issue-digest-test/actions/workflows/ci.yml) as an automated test.
            The title of the discussion will be create a new discussion each week, and every time the action runs a comment will be added with a list of issues changed in the last 24 hours.
          query: |
            owner:sethrylan repo:issue-digest-test updated:>=${{ steps.last.outputs.day }}
          title: 'Issue Radar for Week of ${{ steps.last.outputs.monday }}'
